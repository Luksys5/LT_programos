#!/bin/bash
#------------------------------------------------------------------------------
#$Author$
#$Date$
#$Revision$
#$URL$
#------------------------------------------------------------------------------

SCRIPT=false
FORCE=false
EMPTY=false
VERBOSE=false
DEBUG=false

FILES=""

while [ $# -gt 0 ]
do
    case "$1" in
        -a|--all|--al|--a)
            EMPTY=false
            ;;
        -e|--empty|--empt|--emp|--em|--e)
            EMPTY=true
            ;;
        -f|--force|--forc|--for|--fo|--f)
            FORCE=true
            ;;
        -f-|--no-force|--no-forc|--no-for|--no-fo|--no-f)
            FORCE=false
            ;;
        -v|--verbose|--verbos|--verbo|--verb|--ver|--ve|--v)
            VERBOSE=true
            ;;
        -q|--quiet|--quie|--qui|--qu|--q|\
        -v-|--not-verbose|--not-verbos|--not-verbo|--not-verb|--not-ver|\
        --not-ve|--not-v|\
        --no-verbose|--no-verbos|--no-verbo|--no-verb|--no-ver|\
        --no-ve|--no-v)
            VERBOSE=false
            ;;
        --script|--scrip|--scri|--scr|--sc|--s)
            SCRIPT=true
	    ;;
        --run|--ru|--r)
            SCRIPT=false
	    ;;
        --debug|--debu|--deb|--de|--d)
            DEBUG=true
            ;;
        --no-debug|--no-debu|--no-deb|--no-de|--no-d)
            DEBUG=false
            ;;
        -*) echo "$0: unknown option '$1'" >&2
            exit 1
	    ;;
        *)  FILES="'$1' ${FILES}"
    esac
    shift
done

if [ -z "${FILES}" ]
then
    FILES="."
fi

eval set -- "${FILES}"

find "$@" -name .svn -prune -o -type f \
	-exec bash -c \
'
test '${DEBUG}' = true && set -x

set -e
file="{}"

svn_time=`svn proplist -v "$file" \
| awk "/svn:text-time/{getline; print \\\$1}"`

if [ "'$FORCE'" = true -o "'$EMPTY'" = true -a -z "$svn_time" ] \
   || ( [ "'$EMPTY'" = false ] && svn proplist "$file" | grep -q svn:text-time )
then
    ls_longtime=`(
	export TZ=UTC
	ls -ld --time-style="+%Y-%m-%dT%H:%M:%S" "$file" | awk "{print \\\$6}"
    )`
    ls_microseconds=`(
	export TZ=UTC
	ls -ld --time-style="+%N" "$file" | awk "{printf \"%06d\n\", \\\$6/1000}"
    )`
    ls_time="${ls_longtime}.${ls_microseconds}Z"
    if [ "${ls_time}" != "${svn_time}" ]
    then
        cmd1="svn propset svn:text-time \"${ls_time}\" \"$file\" > /dev/null"
        cmd2="svn proplist -v \"$file\""
        if [ "'$SCRIPT'" = false ]
        then
            eval $cmd1
            if [ "'$VERBOSE'" = true ]
            then
                eval $cmd2
            fi
	else
            echo $cmd1
            if [ "'$VERBOSE'" = true ]
            then
                echo $cmd2
            fi
        fi
        ## echo "text-time \"${ls_time}\""
        ## echo "replaces  \"${svn_time}\" on \"$file\""
        ## echo ""
    fi
fi
' \;

test $SCRIPT = true && echo "*** tree not modified"
