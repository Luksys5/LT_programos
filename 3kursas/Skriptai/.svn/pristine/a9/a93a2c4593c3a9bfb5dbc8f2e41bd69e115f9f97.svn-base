#!/bin/sh
#------------------------------------------------------------------------
#$Author: grazulis $
#$Date: 1999/09/01 11:26:36 $ 
#$Locker:  $
#$Revision: 1.0 $
#$Source:  $
#$State: Exp $
#------------------------------------------------------------------------
#*
#  extract importatnt data about derivatives from the MOSFLM log file
#**

set -u
set -e

FILES=""
WHAT="integrating"

awk=gawk

#** OPTIONS:
#**   -b, --boxes
#**   -c, --cell
#**   --help           print short usage message (this message) and exit

while [ $# -gt 0 ]
do
    case "$1" in
        -a|--average-cell|--average-cel|--average-ce|--average-c|\
	--average|--averag|--avera|--aver|--ave|--av|--a)
	    WHAT="avcell"
	    ;;
        -b|--boxes|--boxe|--box|--bo|--b)
	    WHAT="boxes"
	    ;;
        ## --profiles|--profile|--profil|--profi|--prof|--pro|--pr|--p)
	##     WHAT="boxes"
	##     ;;
        -c|--cell|--cel|--ce|--c)
	    WHAT="cell"
	    ;;
        -i|--integrating|--integratin|--integrati|--integrat|--integra|\
	--integr|--integ|--inte|--int|--in|--i)
	    WHAT="integrating"
	    ;;
        --images|--image|--imag|--ima|--im)
	    WHAT="integrating"
	    ;;
        -l|--large-shifts|--large-shift|--large-shif|--large-shi|--large-sh|\
	--large-s|--large|--larg|--lar|--la|--l)
	    WHAT="largeshifts"
	    ;;
        -p|--processing|--processin|--processi|--process|--proces|--proce|\
	--proc|--pro|--pr)
	    WHAT="processing"
	    ;;
        -v|--very-poor|--very-poo|--very-po|--very-p|\
	--very|--ver|--ve|--v)
	    WHAT="verypoor"
	    ;;
	--help|--hel|--he|--h)
	    echo "Usage:"
	    echo ""
	    echo "  `basename $0` [options] mosflm.log"
	    echo ""
	    ${awk} '/^[ \t]*#\*/,/^[ \t]*#\*\*/ \
                    {sub("^[ \t]*#[*]?[*]?","");print}' $0
	    exit
	    ;;
	-*) echo "`basename $0`: unknown option $1"; exit 1 ;;
         *) FILES="$FILES '$1'" ;;
    esac
    shift
done

eval set -- ${FILES}

case ${WHAT} in
    boxes)
	${awk} '/image FILE/{print}/Background residual/,/^ *$/{print} \
                /Profile for box/,/^ *$/' ${1+"$@"}
	;;
    cell)
	${awk} '/Real cell parameters/{getline;print} \
		/exceeds limit of/{print}'  ${1+"$@"}
	;;
    avcell)
	${awk} '/Real cell parameters/{getline;for(i=0;i<6;i++)c[i]+=$i;n++} \
		END{for(i=0;i<6;i++) printf "   %f",c[i]/n; printf "\n"}' \
	    ${1+"$@"}
	;;
    largeshifts)
	${awk} '/Integrating Image/{p=$2 " " $3} \
		/exceeds limit of/{print p, $0}'  ${1+"$@"}
	;;
    integrating)
	${awk} '/Integrating Image/' ${1+"$@"} | sort -n +2 | uniq -c
	;;
    processing)
	${awk} '/Processing Image/'  ${1+"$@"} | sort -n +2 | uniq -c
	;;
    verypoor)
	${awk} '/Integrating Image/{p=$2 " " $3} \
		/Very poor/{print p, $0}' ${1+"$@"}
	;;
esac
