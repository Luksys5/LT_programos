#!/bin/sh -u
#
# This is a script to transfer images from IPS
# cluster
#

DIRECTORY=$1
FILES=$2
COUNT=`expr $3 - 1`
ENDCNT=$4
EXT="image"

set +u
test "$5" != "" && EXT=$5
test "$FTPHOST" = "" && FTPHOST=rapid
set -u

while [ $COUNT -lt $ENDCNT ]
do
   ERRCOUNT=0
   COUNT=`echo $COUNT | awk '{printf "%03d", $1 + 1}'`
   echo ---------- file: $DIRECTORY${FILES}_${COUNT}.${EXT}
   
   TRANSFER="error?"
   while [ $TRANSFER != "OK" ]    
   do
     ftp $FTPHOST <<- eof-ftp > ftp.$$.errors 2>&1
	cd $DIRECTORY
	bin
	get ${FILES}_${COUNT}.${EXT}
	quit
	eof-ftp
     cat ftp.$$.errors
     if [ `wc -l < ftp.$$.errors` -gt 0 ]
     then
        ERRCOUNT=`expr $ERRCOUNT + 1`
        if [ $ERRCOUNT -gt 5 ]
        then
          echo could not continue. exiting
          rm -f ftp.$$.errors
	  exit 1
        fi
        echo trying for the `expr $ERRCOUNT + 1` time
     else
        TRANSFER="OK"
     fi
   done
done

rm -f ftp.$$.errors
